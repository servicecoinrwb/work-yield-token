<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WorkYieldToken V2 Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 2rem;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #111;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px #333;
    }
    h1 {
      color: #fca311;
    }
    .card {
      margin-top: 1rem;
      padding: 1rem;
      background: #222;
      border-radius: 8px;
    }
    input, button {
      margin-top: 10px;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
    }
    input {
      width: 100%;
    }
    button {
      background: #fca311;
      color: black;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WorkYieldToken V2</h1>
    <p>Live token dashboard and interaction tools</p>

    <div class="card">
      <p><strong>üì¶ Available WYT Tokens:</strong> <span id="availableTokens">Loading...</span></p>
      <p><strong>üí∞ pUSD in Contract:</strong> <span id="paymentBalance">Loading...</span></p>
      <p><strong>üè¶ Total Reserve Fund:</strong> <span id="totalReserve">Loading...</span></p>
      <p><strong>üßæ Redemption Fee:</strong> <span id="redemptionFee">Loading...</span></p>
    </div>

    <div class="card">
      <h3>üõí Buy WYT</h3>
      <input id="buyAmount" placeholder="Enter amount to buy (in WYT)" />
      <button onclick="buyWYT()">Buy WYT</button>
    </div>

    <div class="card">
      <h3>üí∏ Redeem WYT</h3>
      <input id="redeemAmount" placeholder="Enter amount to redeem (in WYT)" />
      <button onclick="redeemWYT()">Redeem WYT</button>
    </div>

    <button onclick="connect()">üîå Connect Wallet</button>
  </div>

  <script>
    const CONTRACT_ADDRESS = "0x97500Ac1B27931b0a36fe4713B6Af455F5308545";
    const ABI = [
      "function availableTokens() view returns (uint256)",
      "function contractPaymentTokenBalance() view returns (uint256)",
      "function totalReserveFund() view returns (uint256)",
      "function redemptionFeePercentage() view returns (uint256)",
      "function buyTokens(uint256 amount) external",
      "function redeemTokens(uint256 amount) external",
      "function paymentToken() view returns (address)",
    ];
    const ERC20_ABI = [
      "function approve(address spender, uint256 amount) external returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)",
    ];

    let provider, signer, userAddress, contract, paymentToken;

    async function connect() {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        const tokenAddress = await contract.paymentToken();
        paymentToken = new ethers.Contract(tokenAddress, ERC20_ABI, signer);

        fetchStats();
        alert("Wallet connected: " + userAddress);
      } else {
        alert("Please install MetaMask!");
      }
    }

    async function fetchStats() {
      const [available, paymentBalance, reserve, fee] = await Promise.all([
        contract.availableTokens(),
        contract.contractPaymentTokenBalance(),
        contract.totalReserveFund(),
        contract.redemptionFeePercentage()
      ]);

      const format = (val) => ethers.utils.formatUnits(val, 18);

      document.getElementById("availableTokens").innerText = format(available) + " WYT";
      document.getElementById("paymentBalance").innerText = format(paymentBalance) + " pUSD";
      document.getElementById("totalReserve").innerText = format(reserve) + " pUSD";
      document.getElementById("redemptionFee").innerText = fee + " %";
    }

    async function buyWYT() {
      const amountIn = document.getElementById("buyAmount").value;
      if (!amountIn) return alert("Enter amount");

      const amount = ethers.utils.parseUnits(amountIn, 18);

      const allowance = await paymentToken.allowance(userAddress, CONTRACT_ADDRESS);
      if (allowance.lt(amount)) {
        const approveTx = await paymentToken.approve(CONTRACT_ADDRESS, amount);
        await approveTx.wait();
      }

      const tx = await contract.buyTokens(amount);
      await tx.wait();
      alert("WYT Purchased!");
      fetchStats();
    }

    async function redeemWYT() {
      const amountIn = document.getElementById("redeemAmount").value;
      if (!amountIn) return alert("Enter amount");

      const amount = ethers.utils.parseUnits(amountIn, 18);
      const tx = await contract.redeemTokens(amount);
      await tx.wait();
      alert("WYT Redeemed!");
      fetchStats();
    }
  </script>
</body>
</html>
