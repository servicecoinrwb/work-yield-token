<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WorkYieldToken V2</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { background: #000; color: #fff; font-family: Arial, sans-serif; padding: 2rem; }
    .container { max-width: 600px; margin: auto; background: #111; padding: 2rem; border-radius: 10px; box-shadow: 0 0 10px #333; }
    h1 { color: #fca311; }
    .card { margin-top: 1rem; padding: 1rem; background: #222; border-radius: 8px; }
    input, button { margin-top: 10px; padding: 10px; border: none; border-radius: 6px; font-size: 1rem; }
    input { width: 100%; }
    button { background: #fca311; color: black; cursor: pointer; }
    .row { display: flex; gap: 10px; }
    .row button { flex: 1; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>WorkYieldToken V2</h1>
    <p>Real-time on-chain dashboard and admin controls</p>

    <!-- üìä Stats -->
    <div class="card">
      <p><strong>üì¶ Available WYT Tokens:</strong> <span id="availableTokens">Loading...</span></p>
      <p><strong>üí∞ pUSD in Contract:</strong> <span id="paymentBalance">Loading...</span></p>
      <p><strong>üè¶ Total Reserve Fund:</strong> <span id="totalReserve">Loading...</span></p>
      <p><strong>üßæ Redemption Fee:</strong> <span id="redemptionFee">Loading...</span></p>
    </div>

    <!-- üõí Buy -->
    <div class="card">
      <h3>Buy WYT</h3>
      <input id="buyAmount" placeholder="Amount (e.g. 1.00)" />
      <div class="row">
        <button onclick="setBuyMax()">Max</button>
        <button onclick="buyWYT()">Buy</button>
      </div>
    </div>

    <!-- üí∏ Redeem -->
    <div class="card">
      <h3>Redeem WYT</h3>
      <input id="redeemAmount" placeholder="Amount (e.g. 1.00)" />
      <div class="row">
        <button onclick="setRedeemMax()">Max</button>
        <button onclick="redeemWYT()">Redeem</button>
      </div>
    </div>

    <!-- üõ† Admin Panel -->
    <div id="adminPanel" class="hidden">
      <div class="card">
        <h3>üß† Mint Work Order</h3>
        <input id="mintYield" placeholder="Gross Yield (e.g. 100.00)" />
        <input id="mintDesc" placeholder="Description (e.g. 'Startup Fund')" />
        <button onclick="mintWorkOrder()">Mint</button>
      </div>

      <div class="card">
        <h3>üè¶ Withdraw Fees</h3>
        <button onclick="withdrawFees()">Withdraw</button>
      </div>

      <div class="card">
        <h3>üßæ Set Redemption Fee</h3>
        <input id="newFee" placeholder="Redemption Fee (e.g. 10)" />
        <button onclick="setFee()">Update Fee</button>
      </div>

      <div class="card">
        <h3>‚ùå Cancel Work Order</h3>
        <input id="cancelId" placeholder="Work Order ID to cancel" />
        <button onclick="cancelWorkOrder()">Cancel</button>
      </div>
    </div>

    <button onclick="connect()">üîå Connect Wallet</button>
  </div>

  <script>
    const CONTRACT_ADDRESS = "0x97500Ac1B27931b0a36fe4713B6Af455F5308545";
    const ABI = [
      "function availableTokens() view returns (uint256)",
      "function contractPaymentTokenBalance() view returns (uint256)",
      "function totalReserveFund() view returns (uint256)",
      "function redemptionFeePercentage() view returns (uint256)",
      "function paymentToken() view returns (address)",
      "function owner() view returns (address)",
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address,address) view returns (uint256)",
      "function approve(address,uint256) returns (bool)",
      "function buyTokens(uint256) external",
      "function redeemTokens(uint256) external",
      "function mintFromWorkOrder(uint256,string) external",
      "function withdrawFees() external",
      "function setRedemptionFee(uint256) external",
      "function cancelWorkOrder(uint256) external"
    ];

    let provider, signer, userAddress, contract, paymentToken;

    async function connect() {
      if (!window.ethereum) return alert("Please install MetaMask!");
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      const tokenAddress = await contract.paymentToken();
      paymentToken = new ethers.Contract(tokenAddress, ABI, signer);

      const owner = await contract.owner();
      if (owner.toLowerCase() === userAddress.toLowerCase()) {
        document.getElementById("adminPanel").classList.remove("hidden");
      }

      fetchStats();
      alert("Wallet connected: " + userAddress);
    }

    function format(val) {
      return Number(ethers.utils.formatUnits(val, 18)).toFixed(4);
    }

    async function fetchStats() {
      const [available, paymentBalance, reserve, fee] = await Promise.all([
        contract.availableTokens(),
        contract.contractPaymentTokenBalance(),
        contract.totalReserveFund(),
        contract.redemptionFeePercentage()
      ]);
      document.getElementById("availableTokens").innerText = format(available) + " WYT";
      document.getElementById("paymentBalance").innerText = format(paymentBalance) + " pUSD";
      document.getElementById("totalReserve").innerText = format(reserve) + " pUSD";
      document.getElementById("redemptionFee").innerText = fee + " %";
    }

    async function buyWYT() {
      const input = document.getElementById("buyAmount").value.trim();
      if (!input) return alert("Enter amount");
      const amount = ethers.utils.parseUnits(input, 18);
      const allowance = await paymentToken.allowance(userAddress, CONTRACT_ADDRESS);
      if (allowance.lt(amount)) {
        const approveTx = await paymentToken.approve(CONTRACT_ADDRESS, amount);
        await approveTx.wait();
      }
      const tx = await contract.buyTokens(amount);
      await tx.wait();
      alert("‚úÖ WYT Purchased");
      fetchStats();
    }

    async function redeemWYT() {
      const input = document.getElementById("redeemAmount").value.trim();
      if (!input) return alert("Enter amount");
      const amount = ethers.utils.parseUnits(input, 18);
      const tx = await contract.redeemTokens(amount);
      await tx.wait();
      alert("‚úÖ Redeemed");
      fetchStats();
    }

    async function setBuyMax() {
      const bal = await paymentToken.balanceOf(userAddress);
      document.getElementById("buyAmount").value = format(bal);
    }

    async function setRedeemMax() {
      const bal = await contract.balanceOf(userAddress);
      document.getElementById("redeemAmount").value = format(bal);
    }

    async function mintWorkOrder() {
      const yieldIn = document.getElementById("mintYield").value.trim();
      const descIn = document.getElementById("mintDesc").value.trim();
      if (!yieldIn || !descIn) return alert("Fill both fields");
      const parsed = ethers.utils.parseUnits(yieldIn, 18);
      const tx = await contract.mintFromWorkOrder(parsed, descIn);
      await tx.wait();
      alert("‚úÖ Work order minted");
      fetchStats();
    }

    async function withdrawFees() {
      const tx = await contract.withdrawFees();
      await tx.wait();
      alert("‚úÖ Fees withdrawn");
      fetchStats();
    }

    async function setFee() {
      const feeInput = document.getElementById("newFee").value.trim();
      if (!feeInput) return alert("Enter new fee %");
      const tx = await contract.setRedemptionFee(feeInput);
      await tx.wait();
      alert("‚úÖ Fee updated");
      fetchStats();
    }

    async function cancelWorkOrder() {
      const id = document.getElementById("cancelId").value.trim();
      if (!id) return alert("Enter work order ID");
      const tx = await contract.cancelWorkOrder(id);
      await tx.wait();
      alert("‚úÖ Work order canceled");
      fetchStats();
    }
  </script>
</body>
</html>
