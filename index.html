<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WorkYieldToken V2</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #000; color: #fff; font-family: Arial, sans-serif; padding: 2rem; }
    .container { max-width: 1000px; margin: auto; background: #111; padding: 2rem; border-radius: 10px; box-shadow: 0 0 10px #333; }
    h1 { color: #fca311; }
    .card { margin-top: 1rem; padding: 1rem; background: #222; border-radius: 8px; }
    input, button, select { margin-top: 10px; padding: 10px; border: none; border-radius: 6px; font-size: 1rem; }
    input, select { width: 100%; }
    button { background: #fca311; color: black; cursor: pointer; }
    .row { display: flex; gap: 10px; }
    .row button { flex: 1; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #444; }
    th { color: #fca311; }
    #walletBtn {
      position: absolute;
      top: 20px;
      right: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="text-align:right">
      <button onclick="connect()" id="walletBtn">üîå Connect Wallet</button>
    </div>

    <h1>WorkYieldToken V2</h1>
    <p>Live smart contract dashboard</p>

    <!-- üìä Stats -->
    <div class="card">
      <p><strong>üì¶ Available WYT:</strong> <span id="availableTokens">...</span></p>
      <p><strong>üí∞ Contract pUSD:</strong> <span id="paymentBalance">...</span></p>
      <p><strong>üè¶ Total Reserve:</strong> <span id="totalReserve">...</span></p>
      <p><strong>üßæ Redemption Fee:</strong> <span id="redemptionFee">...</span></p>
    </div>

    <!-- üõí Buy -->
    <div class="card" id="buyCard">
      <h3>Buy WYT</h3>
      <input id="buyAmount" placeholder="Amount (e.g. 1.00)" />
      <div class="row">
        <button onclick="setBuyMax()">Max</button>
        <button onclick="buyWYT()">Buy</button>
      </div>
    </div>

    <!-- üí∏ Redeem -->
    <div class="card" id="redeemCard">
      <h3>Redeem WYT</h3>
      <input id="redeemAmount" placeholder="Amount (e.g. 1.00)" />
      <div class="row">
        <button onclick="setRedeemMax()">Max</button>
        <button onclick="redeemWYT()">Redeem</button>
      </div>
    </div>

    <!-- üîê Admin Tools -->
    <div id="adminPanel" class="hidden">
      <div class="card">
        <h3>üß† Mint Work Order</h3>
        <input id="mintYield" placeholder="Gross Yield (e.g. 100.00)" />
        <input id="mintDesc" placeholder="Description (e.g. 'Job #42')" />
        <button onclick="mintWorkOrder()">Mint</button>
      </div>

      <div class="card">
        <h3>üè¶ Withdraw Fees</h3>
        <button onclick="withdrawFees()">Withdraw</button>
      </div>

      <div class="card">
        <h3>üßæ Set Redemption Fee</h3>
        <input id="newFee" placeholder="Fee % (max 20)" />
        <button onclick="setFee()">Set Fee</button>
      </div>

      <div class="card">
        <h3>‚ùå Cancel Work Order</h3>
        <input id="cancelId" placeholder="Work Order ID" />
        <button onclick="cancelWorkOrder()">Cancel</button>
      </div>
    </div>

    <!-- üìã Work Order Viewer -->
    <div class="card">
      <h3>üìã Work Orders</h3>
      <button onclick="downloadCSV()">üì§ Export CSV</button>
      <table id="ordersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Yield</th>
            <th>Reserve</th>
            <th>Issued</th>
            <th>Status</th>
            <th>Date</th>
            <th>Desc</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- üìà Chart -->
    <div class="card">
      <h3>üìà Yield & Reserve Chart</h3>
      <canvas id="yieldChart" height="200"></canvas>
    </div>

  </div>

  <!-- Continue with JS in Part 2 -->
  <script>
    // PART 2 JS SCRIPT FOLLOWS IN NEXT MESSAGE
  </script>
</body>
</html>
const CONTRACT_ADDRESS = "0x97500Ac1B27931b0a36fe4713B6Af455F5308545";
const ABI = [
  "function availableTokens() view returns (uint256)",
  "function contractPaymentTokenBalance() view returns (uint256)",
  "function totalReserveFund() view returns (uint256)",
  "function redemptionFeePercentage() view returns (uint256)",
  "function paymentToken() view returns (address)",
  "function owner() view returns (address)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address,address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)",
  "function buyTokens(uint256) external",
  "function redeemTokens(uint256) external",
  "function mintFromWorkOrder(uint256,string) external",
  "function withdrawFees() external",
  "function setRedemptionFee(uint256) external",
  "function cancelWorkOrder(uint256) external",
  "function nextWorkOrderId() view returns (uint256)",
  "function workOrders(uint256) view returns (uint256 id, uint256 grossYield, uint256 reserveAmount, uint256 tokensIssued, bool isActive, bool isPaid, string description, uint256 createdAt)"
];

let provider, signer, contract, userAddress, paymentToken;

function format(val) {
  return Number(ethers.utils.formatUnits(val, 18)).toFixed(4);
}

async function connect() {
  if (!window.ethereum) return alert("Install MetaMask!");
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAddress = await signer.getAddress();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  const tokenAddr = await contract.paymentToken();
  paymentToken = new ethers.Contract(tokenAddr, ABI, signer);

  const owner = await contract.owner();
  const isOwner = owner.toLowerCase() === userAddress.toLowerCase();
  if (isOwner) document.getElementById("adminPanel").classList.remove("hidden");
  else {
    document.getElementById("buyCard").classList.remove("hidden");
    document.getElementById("redeemCard").classList.remove("hidden");
  }

  fetchStats();
  fetchOrders();
}

async function fetchStats() {
  const [avail, bal, reserve, fee] = await Promise.all([
    contract.availableTokens(),
    contract.contractPaymentTokenBalance(),
    contract.totalReserveFund(),
    contract.redemptionFeePercentage()
  ]);
  document.getElementById("availableTokens").innerText = format(avail) + " WYT";
  document.getElementById("paymentBalance").innerText = format(bal) + " pUSD";
  document.getElementById("totalReserve").innerText = format(reserve) + " pUSD";
  document.getElementById("redemptionFee").innerText = fee + " %";
}

async function buyWYT() {
  const input = document.getElementById("buyAmount").value.trim();
  if (!input) return alert("Enter amount");
  const amt = ethers.utils.parseUnits(input, 18);
  const allowance = await paymentToken.allowance(userAddress, CONTRACT_ADDRESS);
  if (allowance.lt(amt)) {
    const approveTx = await paymentToken.approve(CONTRACT_ADDRESS, amt);
    await approveTx.wait();
  }
  const tx = await contract.buyTokens(amt);
  await tx.wait();
  alert("‚úÖ Bought");
  fetchStats();
}

async function redeemWYT() {
  const input = document.getElementById("redeemAmount").value.trim();
  if (!input) return alert("Enter amount");
  const amt = ethers.utils.parseUnits(input, 18);
  const tx = await contract.redeemTokens(amt);
  await tx.wait();
  alert("‚úÖ Redeemed");
  fetchStats();
}

async function setBuyMax() {
  const bal = await paymentToken.balanceOf(userAddress);
  document.getElementById("buyAmount").value = format(bal);
}

async function setRedeemMax() {
  const bal = await contract.balanceOf(userAddress);
  document.getElementById("redeemAmount").value = format(bal);
}

async function mintWorkOrder() {
  const yieldIn = document.getElementById("mintYield").value.trim();
  const desc = document.getElementById("mintDesc").value.trim();
  if (!yieldIn || !desc) return alert("Fill both fields");
  const parsed = ethers.utils.parseUnits(yieldIn, 18);
  const tx = await contract.mintFromWorkOrder(parsed, desc);
  await tx.wait();
  alert("‚úÖ Minted");
  fetchStats();
  fetchOrders();
}

async function withdrawFees() {
  const tx = await contract.withdrawFees();
  await tx.wait();
  alert("‚úÖ Fees withdrawn");
  fetchStats();
}

async function setFee() {
  const fee = document.getElementById("newFee").value.trim();
  if (!fee) return alert("Enter a number");
  const tx = await contract.setRedemptionFee(fee);
  await tx.wait();
  alert("‚úÖ Fee updated");
  fetchStats();
}

async function cancelWorkOrder() {
  const id = document.getElementById("cancelId").value.trim();
  if (!id) return alert("Enter ID");
  const tx = await contract.cancelWorkOrder(id);
  await tx.wait();
  alert("‚úÖ Cancelled");
  fetchOrders();
}

async function fetchOrders() {
  const table = document.querySelector("#ordersTable tbody");
  table.innerHTML = "";

  const rows = [];
  const chartLabels = [];
  const chartTokens = [];
  const chartReserve = [];

  const nextId = await contract.nextWorkOrderId();
  for (let i = 1; i < nextId; i++) {
    const o = await contract.workOrders(i);
    const status = o.isActive ? "Active" : o.isPaid ? "Paid" : "Cancelled";
    const row = `
      <tr>
        <td>${o.id}</td>
        <td>${format(o.grossYield)}</td>
        <td>${format(o.reserveAmount)}</td>
        <td>${format(o.tokensIssued)}</td>
        <td>${status}</td>
        <td>${new Date(o.createdAt * 1000).toLocaleDateString()}</td>
        <td>${o.description}</td>
      </tr>`;
    table.innerHTML += row;

    chartLabels.push(new Date(o.createdAt * 1000).toLocaleDateString());
    chartTokens.push(Number(format(o.tokensIssued)));
    chartReserve.push(Number(format(o.reserveAmount)));
  }

  renderChart(chartLabels, chartTokens, chartReserve);
}

function downloadCSV() {
  const rows = [["ID","Yield","Reserve","Issued","Status","Date","Description"]];
  const table = document.querySelector("#ordersTable tbody").rows;
  for (let r of table) {
    const row = Array.from(r.cells).map(c => `"${c.innerText}"`);
    rows.push(row);
  }
  const blob = new Blob([rows.map(r => r.join(",")).join("\n")], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "work_orders.csv";
  link.click();
}

function renderChart(labels, tokens, reserves) {
  const ctx = document.getElementById("yieldChart").getContext("2d");
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: "Tokens Issued", data: tokens, borderColor: "#fca311", tension: 0.3 },
        { label: "Reserve Amount", data: reserves, borderColor: "#00ff99", tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: "#fff" } }
      },
      scales: {
        x: { ticks: { color: "#fff" } },
        y: { ticks: { color: "#fff" } }
      }
    }
  });
}
</script>
</body>
</html>
